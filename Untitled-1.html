<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard de Inventario</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, Arial, sans-serif; background:#0f1220; color:#eaeaf0; padding: 20px; }
    .card { background:#171a2b; border-radius:12px; padding:16px; max-width: 900px; margin: 0 auto; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    h1 { margin: 0 0 12px; }
    .controls { display:flex; gap:10px; flex-wrap:wrap; align-items:end; }
    .controls label { font-size: 12px; opacity:.9; }
    .controls input, .controls button {
      background:#0f1220; color:#eaeaf0; border:1px solid #2a2f55; border-radius:8px; padding:8px 10px;
    }
    .controls button { cursor:pointer; background:#5b6cff; border:none; }
    .controls button.secondary { background:#2a2f55; }
    table { width:100%; border-collapse: collapse; margin-top: 16px; }
    th, td { padding:10px; border-bottom:1px solid #2a2f55; }
    th { text-align:left; font-size:12px; text-transform:uppercase; letter-spacing:.04em; opacity:.8; }
    tfoot td { font-weight:700; }
    .empty { opacity:.7; text-align:center; padding:20px; }
    .footer { text-align:center; opacity:.6; margin-top: 16px; font-size:12px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>ðŸ“Š Inventario</h1>

    <div class="controls">
      <div>
        <label>Fecha inicio</label><br />
        <input type="date" id="fechaInicio" />
      </div>
      <div>
        <label>Fecha fin</label><br />
        <input type="date" id="fechaFin" />
      </div>
      <button id="btnConsultar">Consultar</button>
      <button class="secondary" id="btnExportar">Exportar CSV</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Producto</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="2" class="empty">Selecciona un rango y consulta ðŸ‘†</td></tr>
      </tbody>
      <tfoot>
        <tr>
          <td>Total items</td>
          <td id="totalItems">0</td>
        </tr>
      </tfoot>
    </table>

    <div class="footer">Vanilla JS â€¢ MVP</div>
  </div>

  <script>
    const API_URL = "https://whatsapp-twilio-1.onrender.com/reportes/inventario"; // ðŸ‘ˆ cambia esto

    const btnConsultar = document.getElementById("btnConsultar");
    const btnExportar = document.getElementById("btnExportar");
    const tbody = document.getElementById("tbody");
    const totalItemsEl = document.getElementById("totalItems");

    btnConsultar.addEventListener("click", consultar);
    btnExportar.addEventListener("click", exportarCSV);

    async function consultar() {
      const fechaInicio = document.getElementById("fechaInicio").value;
      const fechaFin = document.getElementById("fechaFin").value;

      if (!fechaInicio || !fechaFin) {
        alert("Selecciona fecha inicio y fin");
        return;
      }

      tbody.innerHTML = `<tr><td colspan="2" class="empty">Cargando...</td></tr>`;
      totalItemsEl.textContent = "0";

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ fechaInicio, fechaFin })
        });
        console.log(``)
        if (!res.ok) throw new Error("Error en la API");

        const data = await res.json();
        renderTabla(data.inventario || []);
      } catch (err) {
        console.error(err);
        tbody.innerHTML = `<tr><td colspan="2" class="empty">Error consultando inventario</td></tr>`;
      }
    }

    function renderTabla(items) {
      if (!items.length) {
        tbody.innerHTML = `<tr><td colspan="2" class="empty">Sin resultados</td></tr>`;
        totalItemsEl.textContent = "0";
        return;
      }

      let totalItems = 0;
      tbody.innerHTML = items.map(it => {
        totalItems += Number(it.total || 0);
        return `<tr><td>${escapeHtml(it.producto)}</td><td>${it.total}</td></tr>`;
      }).join("");

      totalItemsEl.textContent = totalItems;
    }

    function exportarCSV() {
      const rows = [["Producto", "Total"]];
      document.querySelectorAll("#tbody tr").forEach(tr => {
        const tds = tr.querySelectorAll("td");
        if (tds.length === 2 && !tr.querySelector(".empty")) {
          rows.push([tds[0].innerText, tds[1].innerText]);
        }
      });

      if (rows.length === 1) {
        alert("No hay datos para exportar");
        return;
      }

      const BOM = "\uFEFF";
      const csv = rows
        .map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(";"))
        .join("\n");

      const blob = new Blob([BOM + csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "inventario.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
  </script>
</body>
</html>
